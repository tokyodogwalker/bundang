<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¶„ë‹¹êµ¬ ê´€ë¦¬ë¹„ í­íƒ„ íŒë…ê¸°</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: sans-serif; overflow: hidden; }
    #map { width: 100%; height: 100vh; }
    .glass-card-dark { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); color: white; }
    
    /* ë§ˆì»¤ ë°°ê²½ ì–´ë‘¡ê²Œ */
    .marker-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
    .marker-circle { 
      width: 44px; height: 44px; border-radius: 50%; background: #1e293b; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 20px; border: 3px solid #ccc; transition: 0.2s; cursor: pointer; 
    }
    
    /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
    .marker-leading { border-color: #fbbf24; box-shadow: 0 0 10px #fbbf24; }
    .marker-remodel { border-color: #a855f7; box-shadow: 0 0 10px #a855f7; }
    .marker-safe    { border-color: #38bdf8; }
    .marker-normal  { border-color: #94a3b8; }
    .marker-high    { border-color: #ef4444; }
    .marker-low     { border-color: #10b981; }
    .marker-mid     { border-color: #475569; }

    .marker-label { position: absolute; top: 48px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; white-space: nowrap; }
    #detail-card { transition: transform 0.4s; z-index: 1000; }
    .card-visible { transform: translate(-50%, 0) !important; }
  </style>
</head>
<body class="relative">

  <div id="map"></div>

  <div id="detail-card" class="absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px] translate-y-[150%]">
    <div class="glass-card-dark rounded-[32px] p-6 shadow-2xl border border-white/10">
      <div class="flex justify-between items-start mb-4">
        <div id="card-emoji" class="text-5xl"></div>
        <button onclick="closeCard()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <h2 id="card-title" class="text-2xl font-bold mb-2"></h2>
      <div id="card-badges" class="flex flex-wrap gap-2 mb-4"></div>
      
      <div class="grid grid-cols-2 gap-3 mb-4">
         <div class="bg-white/5 p-3 rounded-2xl text-center">
           <p class="text-[10px] text-gray-400">ì¥ê¸°ìˆ˜ì„ ì¶©ë‹¹ê¸ˆ</p>
           <p id="card-balance" class="font-bold text-blue-400">-</p>
         </div>
         <div class="bg-white/5 p-3 rounded-2xl text-center">
           <p class="text-[10px] text-gray-400">ì›” ë¶€ê³¼ì•¡(ã¡ ë‹¹)</p>
           <p id="card-fee" class="font-bold text-white">-</p>
         </div>
      </div>

      <div class="bg-white/5 p-4 rounded-2xl mb-4 text-[11px] space-y-2">
        <div class="flex justify-between"><span>ìŠ¹ê°•ê¸° êµì²´</span><span id="stat-elev"></span></div>
        <div class="flex justify-between"><span>ë°°ê´€/ë‚œë°© ê³µì‚¬</span><span id="stat-pipe"></span></div>
        <div class="flex justify-between text-yellow-400"><span>ë„ì¥/ë°©ìˆ˜ ì´ë ¥</span><span id="stat-paint-water"></span></div>
      </div>

      <div class="p-4 rounded-2xl bg-blue-500/10 border border-blue-500/30 text-[12px] leading-relaxed">
        <p id="card-desc"></p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', { zoomControl: false }).setView([37.382, 127.120], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    function getEmoji(apt) {
      if (apt.risk === 'leading') return 'ğŸ†';
      if (apt.risk === 'remodel') return 'ğŸš§';
      if (apt.risk === 'safe') return 'âœ¨';
      if (apt.risk === 'normal') return 'ğŸ™‚';
      if (apt.risk === 'high') return 'ğŸ˜¡';
      if (apt.risk === 'low') return 'ğŸŸ¢';
      return 'ğŸ¤”';
    }

    fetch('/api/data')
      .then(res => res.json())
      .then(data => {
        data.forEach(apt => {
          const icon = L.divIcon({
            className: 'bg-transparent',
            html: `<div class="marker-wrapper"><div class="marker-circle marker-${apt.risk}">${getEmoji(apt)}</div><span class="marker-label">${apt.name}</span></div>`
          });
          L.marker([apt.lat, apt.lng], { icon }).addTo(map).on('click', () => openCard(apt));
        });
      });

    function openCard(apt) {
      document.getElementById('card-title').innerText = apt.name;
      document.getElementById('card-emoji').innerText = getEmoji(apt);
      document.getElementById('card-balance').innerText = apt.balance;
      document.getElementById('card-fee').innerText = apt.fee;
      document.getElementById('card-desc').innerText = apt.desc;
      
      let badges = `<span class="bg-slate-700 px-2 py-1 rounded text-[10px]">${apt.age}ë…„ì°¨</span>`;
      if(apt.is_special) badges += `<span class="bg-blue-600 px-2 py-1 rounded text-[10px]">âš–ï¸ ë…¸í›„ê³„íšë„ì‹œ</span>`;
      if(apt.is_leading) badges += `<span class="bg-yellow-600 px-2 py-1 rounded text-[10px]">ğŸ† ì„ ë„ì§€êµ¬</span>`;
      if(apt.remodeling_status) badges += `<span class="bg-purple-600 px-2 py-1 rounded text-[10px]">ğŸš§ ë¦¬ëª¨ë¸ë§</span>`;
      document.getElementById('card-badges').innerHTML = badges;

      document.getElementById('stat-elev').innerText = apt.history.elev;
      document.getElementById('stat-pipe').innerText = apt.history.pipe;
      document.getElementById('stat-paint-water').innerText = apt.history.paint_water;

      document.getElementById('detail-card').classList.add('card-visible');
    }

    function closeCard() { document.getElementById('detail-card').classList.remove('card-visible'); }
    map.on('click', closeCard);
  </script>
</body>
</html>